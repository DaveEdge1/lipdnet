extends layout

block css
	link(rel='stylesheet' href='css/upload.css')
	link(rel='stylesheet' href='css/zip-js.css')

block body
	body(ng-app='uploadApp' ng-cloak)
		#wrapper
			include ./include/navbar.jade
			md-toolbar
				.md-toolbar-tools
					.md-title Upload

			.col-sm-8.col-sm-offset-2
						
				#form-container(ng-controller='FormCtrl')
				
					// DEV AREA : Check that everything is binging in angular correctly. 
					h4 Form Data Preview
					p userData
					pre {{ userData }}
					p markers
					pre {{ markers }}
					
					// is this line needed ?
					form#upload-form(ng-submit='')
						// UPLOAD METHOD 2: Use node / multer / angular to POST file data to mongo db
						div(ng-controller="FileCtrl")

							md-toolbar.md-hue-1
								h2.md-toolbar-tools
									span File
									
							// UPLOAD METHOD 1 : use zip.js to unzip the LiPD file into RAM and jsonld file into SessionStorage
							ol
								// Method input: this will always be "RAM", so keep the code here but hide the element on the page
								li(style="display:hide; visibility:hidden;list-style-type: none;")
									label(style="display:hide; visibility:hidden;")
										span#form-label Temp storage
										select#creation-method-input
											option(value="Blob") RAM
								// File chooser: Set to accept LPD file types. 
								li(style="list-style-type: none;")
									label
										span#form-label Load LiPD
										// Bind this to a 'change' event so that we know when jsonld data is available to start processing.
										input#file-input(ngf-select="uploadEvent()" ng-model="file" name='file' type="file" accept=".lpd")
								// When a LPD file is chosen, all the files inside are listed here. 
								li(style="list-style-type: none;")
									span#form-label Contents
									ul#file-list
							br
							
							
																
							// Upload file to session storage
							form#uploadForm(action="/upss" enctype="multipart/form-data" method='')
								//- md-input-container
								//- 	label File type
								//- 	md-select(ng-model='upload.type')
								//- 		md-option(ng-repeat='i in uploadType' value='{{i}}') {{i}}
								md-button(ngf-select="uploadToSession($file)" ng-model='file' name='file' ngf-max-size="50MB") Select File  

							// LATER,  CHANGE THESE TWO BUTTONS TO NG-IF="validated" SO THEY DONT SHOW UP IF DATA IS INVALID 
							// Upload data to database
							form#uploadForm(action="/updb" enctype="multipart/form-data" method='post')
								md-button(ngf-select="uploadToDb($file)" ng-model='file' name='file' ngf-max-size="50MB") Push to Database   

							// Upload data to database
							form#uploadForm(action="/dwnld" enctype="multipart/form-data" method='post')
								md-button(ngf-select="downloadToLocal($file)" ng-model='file' name='file' ngf-max-size="50MB") Download LiPD   

							pre
								p Response Object
								p(ng-if="obj.path") {{obj}}
							pre
								p Uploaded Content
								p(ng-if="obj.path" ng-init='pullFromDb()') {{content}}								
								
						// FORM INPUT
						div
							// METADATA
							md-toolbar.md-hue-1
								h2.md-toolbar-tools
									span Metadata
							md-content(layout-padding='', layout='row', layout-sm='column')
								md-input-container(flex='')
									label Site Name
									input(ng-model='userData.siteName')
								md-input-container(flex='')
									label Collection Name
									input(ng-model='userData.collectionName')
							div(layout='', layout-padding='', layout-sm='column')
								md-input-container(flex='')
									label Archive Type
									input(ng-model='userData.archiveType')
								md-input-container(flex='')
									label Investigators
									input(ng-model='userData.investigators')
								md-input-container(flex='')
									label Data Set Name
									input(ng-model='userData.dataSetName')
							div(layout='', layout-padding='', layout-sm='column')
								md-input-container(flex='')
									label Notes
									textarea(ng-model='userData.notes', columns='1', md-maxlength='150')
							// FUNDING
							md-toolbar.md-hue-1
								h2.md-toolbar-tools
									span Funding
							div(layout='', layout-padding='', layout-sm='column', ng-repeat='item in funding')
								md-input-container(flex='')
									label Agency Name
									input(ng-model='userData.funding[item.id][item.a]')
								md-input-container(flex='')
									label Grant
									input(ng-model='userData.funding[item.id][item.f]')
							div(layout='', layout-padding='', layout-sm='column')
								md-button(ng-click='addFunding()')  + Additional Funding
							// PUBLICATION
							md-toolbar.md-hue-1
								h2.md-toolbar-tools
									span Publication
							// AUTHORS
							div(layout='', layout-padding='', layout-sm='column', ng-repeat='item in authors')
								md-input-container(flex='')
									label Author Name
									input(ng-model='userData.authors[item.id]')
							div(layout='', layout-padding='', layout-sm='column')
								md-button(ng-click='addAuthor()')  + Add Author
							div(layout='', layout-padding='', layout-wrap='', layout-sm='column')
								md-input-container(flex='')
									label DOI
									input(ng-model='userData.pubDoi')
								md-input-container(flex='')
									label Year
									input(ng-model='userData.pubYear')
								md-input-container(flex='')
									label Volume
									input(ng-model='userData.pubVolume')
								md-input-container(flex='')
									label Edition
									input(ng-model='userData.pubEdition')
								md-input-container(flex='')
									label Issue
									input(ng-model='userData.pubIssue')
							// GEOGRAPHY
							md-toolbar.md-hue-1
								h2.md-toolbar-tools
									span Geography
							div(layout='', layout-padding='', layout-sm='column')
								md-input-container
									label Type
									md-select(ng-model='userData.geo.type')
										md-option(default='Feature', ng-repeat='t in geoType', value='{{t}}') {{t}}
							md-subheader.md-primary Geometry
							div(layout='', layout-padding='', layout-sm='column')
								md-input-container
									label Type
									md-select(ng-model='userData.geo.geometry.type')
										md-option(ng-repeat='t in geoGeometryType', value='{{t}}') {{t}}
							// GOOGLE MAP
							// ng-if="userData.geo.geometry.coordinates"
							div
								ui-gmap-google-map(center='map.center', zoom='map.zoom', draggable='true', options='options', bounds='map.bounds')
									ui-gmap-markers(models='markers', coords="'self'", events='events', options='options')
							// COORDINATES
							div(layout='', layout-padding='', layout-sm='column', ng-repeat='obj in markers')
								md-input-container(flex='')
									md-tooltip -90 to 90
									label Latitude
									input(ng-model='markers[$index].latitude', required='', type='number', min='-90', max='90')
								md-input-container(flex='')
									md-tooltip -180 to 180
									label Longitude
									input(ng-model='markers[$index].longitude', required='', type='number', min='-180', max='180')
								md-button(ng-click='removeCoords($index)')  Remove 
							div(layout='', layout-padding='', layout-sm='column')
								md-button(ng-click='addCoordinates()')  + Additional Coordinates
								md-button(ng-click='pushMarkers()')  Save 
							md-subheader.md-primary Properties
							div(layout='', layout-padding='', layout-sm='column')
								md-input-container(flex='')
									label Site Name
									input(ng-model='userData.geo.properties.siteName')
								md-input-container(flex='')
									label Location
									input(ng-model='userData.geo.properties.location')
								md-input-container(flex='')
									label Country
									input(ng-model='userData.geo.properties.country')
							md-subheader.md-primary Elevation
							div(layout='', layout-padding='', layout-sm='column')
								md-input-container(flex='')
									label Value
									input(type='number', ng-model='userData.elevation.value')
								md-input-container(flex='')
									label Units
									md-select(ng-model='userData.elevation.unit')
										md-option(ng-repeat='u in unitsDistance', value='{{u.short}}') {{u.long}}
							// DATA
							md-toolbar.md-hue-1
								h2.md-toolbar-tools
									span Data
							md-subheader.md-primary Core Length
							div(layout='', layout-padding='', layout-sm='column')
								md-input-container(flex='66')
									label Value
									input(type='number', ng-model='userData.core.value')
								md-input-container(flex='')
									label Units
									md-select(ng-model='userData.core.unit')
										md-option(ng-repeat='u in unitsDistance', value='{{u.short}}') {{u.long}}
							div(layout='', layout-padding='', layout-sm='column')
								md-input-container(flex='')
									md-tooltip(md-visible='demo.showTooltip') Here is some more helpful information
									label Table Name
									input(ng-model='userData.dataTableName')
								md-input-container(flex='')
									label File Name
									input(ng-model='userData.dataFileName')
							div(layout='', layout-padding='', layout-sm='column', ng-model='f.columns', ng-repeat='i in columns')
								md-subheader.md-primary Column {{i.column}}
								md-input-container(flex='', ng-repeat='(k,v) in i')
									label {{k}}
									input(value='{{v}}')
							div(layout='', layout-padding='', layout-sm='column')
								md-button(ng-click='addColumn()')  + Add Column
								
							// CHRONOLOGY
							md-toolbar.md-hue-1
								h2.md-toolbar-tools
									span Chronology
							div(layout='', layout-padding='', layout-sm='column')

							md-toolbar.md-hue-1
								h2.md-toolbar-tools
									span Download
							// Download Lipd Button
							// download button should be greyed out or missing until the data is valid and ready
							// figure out how this will zip up the session contents and download to disk
							//- form#upload-form(action="/download")
							//- 	md-button#download(ng-if="validLipd") Download LiPD   
							// use this until testing out "completeness" is finished.
							form#upload-form(action="/filedown")
								p Download the new, valid lipd file
								p This button will activate when the lipd data is valid
								md-button#download() Download LiPD only
								br
								md-button#download() Add LiPD to database 


block js
	script(src='apps/uploadApp.js')
	script(src='js/ngForm.js')
	script(src='js/ngFile.js')
	script(src="lib/zip/zip.js")
	script(src="lib/zip/zip-ext.js")
	script(src="lib/zip/zip-load.js")

	script(src='https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.2.15/angular-ui-router.min.js')
	script(src='https://cdnjs.cloudflare.com/ajax/libs/angular-google-maps/2.2.0/angular-google-maps.min.js')
	script(src='https://cdnjs.cloudflare.com/ajax/libs/danialfarid-angular-file-upload/8.0.1/ng-file-upload-shim.min.js')
	script(src='https://cdnjs.cloudflare.com/ajax/libs/danialfarid-angular-file-upload/8.0.1/ng-file-upload.min.js')
	script(src='//maps.googleapis.com/maps/api/js?sensor=false')
